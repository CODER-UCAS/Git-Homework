# GitHub Actions自动化流程名
name: Apache Maven CI

# 当收到任意分支的推送事件时触发
on: push

# 自动化任务
jobs:
  # 构建任务
  build:
    name: Maven Test

    # 在最新版的Windows虚拟机上测试
    runs-on: windows-latest

    # 测试步骤
    steps:
      # 检出分支
      - name: Checkout branch
        uses: actions/checkout@v2

      # 安装JDK 11环境
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11

      # 缓存Maven依赖项
      - name: Cache Maven dependencies
        uses: actions/cache@v1
        with:
          path: ~/.m2
          key: Git-Homework_Maven_Dependencies
          restore-keys: |
            Git-Homework_Maven_
            Git-Homework_
            Git-
          shell: bash

      # 使用GitHub Secrets解锁私密测试文件
      - name: Decrypt secret files
        run: ./.github/scripts/decrypt.sh
        env:
          DECRYPTION_KEY: ${{ secrets.YOGA_SERIAL }}
        shell: bash

      # 使用Apache Maven构建并测试项目
      - name: Build with Maven
        run: mvn -B test --file pom.xml
        working-directory: ./homework
        continue-on-error: true

      # 移除解密后的测试文件
      - name: Remove Secret File
        run: ls | grep -v .gpg | xargs rm -Rvf
        working-directory: ./homework/src/test/resources
        shell: bash
